<script>
  const pdfInput = document.getElementById('pdfInput');
  const pdfPreview = document.getElementById('pdfPreview');
  const schedaDiv = document.getElementById('scheda');
  const saveBtn = document.getElementById('saveBtn');
  const pdfName = document.getElementById('pdfName');
  const archivio = document.getElementById('archivio');

  let currentPdfArrayBuffer = null;

  const archivioPDFs = JSON.parse(localStorage.getItem('archivioPDFs') || '{}');
  for (let nome in archivioPDFs) {
    const opt = document.createElement('option');
    opt.value = nome;
    opt.textContent = nome;
    archivio.appendChild(opt);
  }

  saveBtn.addEventListener('click', () => {
    const nome = pdfName.value.trim();
    if (!nome || !currentPdfArrayBuffer) return alert("Inserisci un nome valido e carica un PDF.");
    archivioPDFs[nome] = Array.from(new Uint8Array(currentPdfArrayBuffer));
    localStorage.setItem('archivioPDFs', JSON.stringify(archivioPDFs));
    const opt = document.createElement('option');
    opt.value = nome;
    opt.textContent = nome;
    archivio.appendChild(opt);
    pdfName.value = '';
    alert("PDF archiviato con successo.");
  });

  archivio.addEventListener('change', () => {
    const nome = archivio.value;
    if (!nome) return;
    const byteArray = new Uint8Array(archivioPDFs[nome]);
    renderPDF(byteArray);
  });

  pdfInput.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      currentPdfArrayBuffer = reader.result;
      renderPDF(new Uint8Array(reader.result));
    };
    reader.readAsArrayBuffer(file);
  });

  async function renderPDF(data) {
    const pdf = await pdfjsLib.getDocument({ data }).promise;
    pdfPreview.innerHTML = '';
    schedaDiv.innerHTML = '';
    let fullText = '';

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport }).promise;
      pdfPreview.appendChild(canvas);

      const content = await page.getTextContent();
      fullText += content.items.map(item => item.str).join(' ') + '\n';
    }

    // Suddividi in sezioni
    const sezioni = {
      Riscaldamento: '',
      Esercizi: '',
      Defaticamento: ''
    };

    const pattern = /Riscaldamento|Esercizi|Defaticamento/gi;
    const parti = fullText.split(pattern).map(p => p.trim());
    const titoli = [...fullText.matchAll(pattern)].map(m => m[0]);

    titoli.forEach((titolo, i) => {
      if (sezioni[titolo]) {
        sezioni[titolo] += parti[i + 1];
      }
    });

    for (let titolo in sezioni) {
      if (sezioni[titolo]) {
        const blocco = sezioni[titolo];
        const esercizi = blocco.split('-').map(s => s.trim()).filter(s => s);
        let tabella = `<table><thead><tr><th>${titolo}</th></tr></thead><tbody>`;
        esercizi.forEach(ex => tabella += `<tr><td>${ex}</td></tr>`);
        tabella += '</tbody></table><br>';
        schedaDiv.innerHTML += tabella;
      }
    }
  }
</script>
